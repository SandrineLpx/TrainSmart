# Iterations 2-12 - 2026-02-10 to 2026-02-14 (Consolidated Log)

## Historical note
This file intentionally includes multiple iterations in one document. Legacy references (for example, `training_log.json`) are retained where they describe past states.

## What changed

### Session system: A/B/C → T/S/H

Renamed the entire session labeling system for clarity:

| Old | New | Meaning |
|-----|-----|---------|
| A | **S** (Strength) | Squats, jerks, leg drive — Monday + Thursday program exercises |
| B | **T** (Technique) | Snatch pulls, snatch technique — Tuesday program exercises |
| C | **H** (Heavy) | Heavy singles, competition lifts — Friday program exercises |

**Files updated:** CLAUDE.md, all 3 skill SKILL.md files, current_week_plan.json, training_log.json (seed data).

### Session intensity options

Added three intensity levels to every session type:

- **Light (mini)**: Only 1-2 main lifts, reduced sets. For fatigue/deload.
- **Normal**: As prescribed in program.json. Default.
- **Condensed**: As prescribed + priority exercises pulled from skipped program days. For fewer training days with full coverage.

Condensed session rules:
- Take main lifts from the assigned day
- Add top 1-2 priority exercises from skipped days (Olympic lifts > squats > accessories)
- Cut accessories from base day to keep total ≤ 6 exercises

**Example (3 days in Week 2):** Mon S-condensed covers strength + technique + squats, Wed Hybrid-normal covers jerk work, Fri H-normal covers heavy day. Nothing critical missed.

### /weekly-plan improvements

- **Single question for day selection**: "Which days are you training this week?" replaces "how many days?" + "any days off?" (was 5 questions, now 4)
- **0-5 training days**: Added support for 0 days (rest week) and 4-5 days (was limited to 1-3)
- **Priority assignment for N days**: T → S → H → Hybrid → full week
- **Intensity assigned per session** based on fatigue, days available, and athlete preference
- **Condensed session building logic** added to Step 3
- **Updated JSON schema**: each schedule entry now includes `"intensity"` field

### /checkin improvements

- **Step 0 — Show context first**: Before asking anything, displays program name, start date, current week, and today's date on one line
- **No-plan fallback with numbered options**: "1. Run /weekly-plan" or "2. Skip" for fast response
- **Updated decision table** with T/S/H + Condensed row
- **Condensed readiness rule**: if readiness is bad, drop condensed extras and run as normal or light

### /log-session improvements

- Updated session type options: `T / S / H / mini-T / mini-S / mini-H / cardio / recovery`
- Added `intensity` field to JSON entry structure

### Other changes

- **`scripts/parse_excel.py`** — Added `_write_summary()` function that auto-generates `data/program_summary.md` with all weeks, exercises, and volume progression table
- **`references/` folder** — Renamed from `reference/`; contains Leg Drive.xlsx, assignment doc, archived v1 skills doc
- **`data/program_summary.md`** — New auto-generated readable overview of the loaded program

## Bug fix: Strava SSL context missing on activity fetch

### Problem
`/checkin` failed to connect to Strava with `SSL: CERTIFICATE_VERIFY_FAILED — self-signed certificate in certificate chain`. The weather MCP also failed as a cascade (parallel call batch).

### Root cause
In `mcp_servers/strava_mcp.py`, the `SSL_CONTEXT` (built from `certifi` CA bundle) was correctly passed to the token refresh call (line 54) but **not** to the activity fetch call (line 99):

```python
# Line 54 — token refresh (correct):
urllib.request.urlopen(req, timeout=10, context=SSL_CONTEXT)

# Line 99 — activity fetch (missing SSL_CONTEXT):
urllib.request.urlopen(req, timeout=10)  # ← bug
```

Without the SSL context, Python falls back to default certificate verification, which fails on Windows when the venv's Python can't access the Windows certificate store.

### Fix
Added `context=SSL_CONTEXT` to line 99 in `strava_mcp.py`:

```python
with urllib.request.urlopen(req, timeout=10, context=SSL_CONTEXT) as resp:
```

One-line fix. `certifi` was already installed and the SSL context was already being created correctly at module level — it just wasn't being used consistently.

### Weather cascade
The weather MCP (`weather_mcp.py`) was not affected independently. It uses Open-Meteo (public CA-signed certs) and works fine. It only failed because it was called in the same parallel tool batch as Strava, and the batch errored out.

---

## Prompt iteration 3: A/B/C → T/S/H + intensity options

### Problem
The A/B/C labels were abstract and didn't convey what each session focused on. The athlete had to remember the mapping. Also, there was no way to express "I want to train fewer days but still cover everything."

### Before (v2):
> Session types: A (Monday exercises), B (Tuesday exercises), C (Friday exercises). One intensity level: as prescribed.

### After (v3):
> Session types: **T** (Technique), **S** (Strength), **H** (Heavy). Three intensities: **light** (mini), **normal** (as prescribed), **condensed** (as prescribed + key exercises from skipped days).

### Key design change
> `/weekly-plan` now assigns both a **type** and an **intensity** per session. When the athlete trains fewer than 5 days, condensed sessions pull priority exercises from skipped program days so nothing critical is missed. Accessories are cut first to keep sessions manageable.

**Why:** T/S/H is self-documenting — the athlete immediately knows what a session focuses on. Intensity options give flexibility: train 3 days with condensed coverage vs. 3 days with normal volume. This maps to real-world decisions athletes make weekly.

## Prompt iteration 4: Simplified weekly planning questions

### Before (v2):
> ```
> 1. How many WL sessions this week? (1/2/3)
> 2. Want to plan outdoor cardio?
> 3. Any days you definitely CAN'T train?
> 4. How are you feeling? Fatigue: low/medium/high, any pain?
> 5. Competition coming up?
> ```

### After (v3):
> ```
> 1. Which days are you training this week? (e.g., "Tue, Thu, Sat" or "none" or "Mon-Fri")
> 2. Want to plan outdoor cardio?
> 3. How are you feeling? Fatigue: low/medium/high, any pain?
> 4. Competition coming up?
> ```

**Why:** One direct question ("which days") replaces two indirect questions ("how many" + "which days off"). The number of days is inferred. Supports 0-5 days naturally. Faster to answer.

## Prompt iteration 5: Checkin context line + no-plan numbered options

### Before (v2):
> `/checkin` jumped straight to asking 3 questions. If no weekly plan existed, it gave a paragraph explanation with options.

### After (v3):
> `/checkin` Step 0 shows: `**Program:** Leg Drive | **Started:** 2026-02-02 | **Week 2 of 8** | **Tuesday, 2026-02-10**`
>
> If no plan: `"No weekly plan found. 1. Run /weekly-plan (~1 min) 2. Skip — quick recommendation"`

**Why:** The context line catches errors fast (wrong week, wrong program) before the athlete answers questions. Numbered options are faster to respond to than reading a paragraph.

## File structure after this iteration

```
Training_App/
├── .claude/skills/
│   ├── checkin/SKILL.md          (T/S/H + Step 0 context + numbered no-plan fallback)
│   ├── log-session/SKILL.md      (T/S/H + intensity field)
│   └── weekly-plan/SKILL.md      (T/S/H + intensity + condensed + 0-5 days)
├── .mcp.json
├── .gitignore
├── CLAUDE.md                     (T/S/H system + intensity options documented)
├── data/
│   ├── program.json
│   ├── program_summary.md        (NEW — auto-generated by parse_excel.py)
│   ├── training_log.json         (seed data updated: S, T, cardio, H)
│   ├── current_week_plan.json    (types updated + intensity field added)
│   ├── preferences.json
│   ├── strava_config.json        (gitignored)
│   └── strava_config.template.json
├── mcp_servers/
│   ├── weather_mcp.py
│   └── strava_mcp.py
├── scripts/
│   ├── parse_excel.py            (+ _write_summary() for program_summary.md)
│   └── strava_auth.py
├── references/                   (renamed from reference/)
│   ├── training_skills_ABC_v1.md
│   ├── Leg Drive.xlsx
│   └── MSIS549_HW2_Agentic_AI.docx.md
└── iterations/
    ├── iteration_01_2026-02-09.md
    └── iteration_02_2026-02-10.md (this file)
```

## Future iterations

### Multi-program support (planned)
Support running multiple programs concurrently (e.g., base WL program + squat specialization cycle).

**Design:**
- Move `data/program.json` → `data/programs/` folder with a `manifest.json`
- `manifest.json` tracks one base program + N additional programs, each with its own start date and week count
- Each additional program has a `replaces` list: exercise names from the base program that it supersedes
- `/weekly-plan` merges programs: when building a day's exercises, swaps base exercises for additional program versions where overlap exists
- No auto-detection — `replaces` is manual (explicit > clever)
- Session types (T/S/H) stay the same; additional program sessions slot into existing types

**Example:**
```json
{
  "base": { "file": "leg_drive.json", "start_date": "2026-02-02" },
  "additional": [
    {
      "file": "squat_cycle.json",
      "start_date": "2026-02-10",
      "replaces": ["Front Squat", "Pause Back Squat", "Goblet Squat"]
    }
  ]
}
```

**Scope:** This adds merge logic to `/weekly-plan`, `/checkin`, and `/log-session`. Deferred to a future iteration to keep current scope focused on getting the base system working well.

## Performance improvement: Prompt deduplication (Iteration 6)

### Problem
Each skill SKILL.md repeated information already defined in CLAUDE.md:
- Strava activity classification (5 activity types + rules) — duplicated in checkin + weekly-plan
- T/S/H session type definitions — re-stated in weekly-plan
- Intensity definitions (light/normal/condensed) — re-stated in weekly-plan
- Stop rules text — repeated 3x verbatim in checkin output templates
- Week calculation formula — repeated in all 3 skills
- PR-tracked exercise list — repeated in log-session

Since CLAUDE.md is always loaded as context alongside any skill, these duplications increase prompt token count without adding information.

### Changes
Replaced duplicated content with references to the relevant CLAUDE.md section:
- `"Classify per CLAUDE.md 'Strava Activity Types'"` instead of listing all 5 activity types
- `"Calculate current week per CLAUDE.md formula"` instead of repeating the formula
- `"Assign T/S/H per CLAUDE.md 'T/S/H Session System'"` instead of redefining them
- `"PR-tracked exercises (see CLAUDE.md 'Personal Records')"` instead of re-listing all 11 exercises
- `"[2 stop rules from CLAUDE.md]"` instead of writing them out 3 times

Also tightened verbose prose, collapsed multi-line explanations into single lines, and compacted JSON examples.

### Results

| Skill | Before | After | Reduction |
|-------|--------|-------|-----------|
| checkin/SKILL.md | 185 lines | 109 lines | -41% |
| weekly-plan/SKILL.md | 212 lines | 127 lines | -40% |
| log-session/SKILL.md | 120 lines | 83 lines | -31% |
| **Total** | **517 lines** | **319 lines** | **-38%** |

### Why this matters
- Fewer prompt tokens per skill invocation → faster response time, lower cost
- Single source of truth: updating a rule in CLAUDE.md automatically applies everywhere
- No information lost — all decision rules, thresholds, and output formats are preserved
- The skills remain self-contained as workflows (step-by-step instructions are still in the skill) but delegate domain knowledge to CLAUDE.md

## Performance improvement: Extract schemas + skip redundant reads (Iteration 7)

### Problem
After iteration 6, skills were shorter but still contained:
- Full JSON schema examples (plan, log entries) inline — 20+ lines each
- Full output templates inline — 15+ lines each
- `/checkin` read `program.json` on every run just to get `program_name` and `total_weeks`, even though `current_week_plan.json` already had the session data

These are reference material, not execution logic. They inflate the prompt that's loaded on every invocation.

### Changes

**1. Created `references/skill_schemas.md`** — single reference file containing:
- `current_week_plan.json` full schema (with new `program_name` + `total_weeks` fields)
- `training_log.json` entry schemas (WL + cardio)
- Condensed session worked example
- All output templates (checkin: 3 variants, weekly-plan, log-session)

Skills now say `"Format per template in references/skill_schemas.md"` instead of embedding templates.

**2. Checkin: skip `program.json` read**
- `current_week_plan.json` now includes `program_name` and `total_weeks` (written by `/weekly-plan`)
- `/checkin` reads only the plan file — one fewer tool call per invocation
- `program.json` is only read in the no-plan fallback path

**3. Updated `data/current_week_plan.json`** — added `program_name` and `total_weeks` fields to existing plan.

### Results

| Skill | Iteration 6 | Iteration 7 | Reduction |
|-------|-------------|-------------|-----------|
| checkin/SKILL.md | 109 lines | 65 lines | -40% |
| weekly-plan/SKILL.md | 127 lines | 58 lines | -54% |
| log-session/SKILL.md | 83 lines | 39 lines | -53% |
| **Total** | **319 lines** | **162 lines** | **-49%** |

**Cumulative reduction from original:** 517 → 162 lines (**-69%**)

### Why this matters
- Skills now contain only execution logic (what to do, when to decide, which rules to apply)
- Reference material lives in one place (`references/skill_schemas.md`) — read only when needed
- `/checkin` saves one tool call per run (no program.json read) — faster response
- Adding a new output field or changing a template requires editing one file, not three

## Performance improvement: MCP response caching (Iteration 8)

### Problem
During a single `/weekly-plan` or `/checkin` flow, the same MCP tool can be called multiple times (e.g., weather called with days=7, then days=1; or Strava called by checkin after weekly-plan just called it). Each call hits the external API, adding latency and risking rate limits.

Additionally, `strava_mcp.py` reads `strava_config.json` from disk on every `get_activities` call, even though the config rarely changes within a session.

### Changes

**weather_mcp.py:**
- Added in-memory cache keyed by `(lat, lon, days)` with 12-hour TTL
- Same forecast request within 12 hours returns cached response instantly
- No new dependencies — uses module-level dict + `time.time()`

**strava_mcp.py:**
- Added in-process config cache (`_config_cache`) — config file read once, then served from memory
- Cache invalidated on token refresh (`_save_config` updates both disk and cache)
- Added activity cache keyed by `days_back` with 6-hour TTL

### Implementation
```python
# weather_mcp.py
_CACHE_TTL = 43200  # 12 hours
_cache = {}  # (lat, lon, days) -> {"ts": float, "data": str}

# strava_mcp.py
_CACHE_TTL = 21600  # 6 hours
_config_cache = None  # read-once config
_activity_cache = {}  # days_back -> {"ts": float, "data": str}
```

### Why these TTLs
- Weather (12 hours): forecasts don't change meaningfully within a training day; one API call per day is sufficient
- Strava activities (6 hours): activities are historical and rarely change within a training day
- Config (indefinite until refresh): only changes on OAuth token refresh, which `_save_config` handles

## Performance improvement: NDJSON training log (Iteration 9)

### Problem
`training_log.json` used a JSON array (`{"entries":[...]}`). Every `/log-session` call had to:
1. Read the entire file
2. Parse the full JSON
3. Append one entry to the array
4. Serialize and rewrite the entire file

With 3 sessions/week, the file grows ~150 entries/year. Each write rewrites all previous entries — O(n) per append.

### Change
Switched to NDJSON (newline-delimited JSON): `data/training_log.ndjson`
- Each line is a self-contained JSON object
- **Write:** `echo '<json>' >> data/training_log.ndjson` — O(1) append, no read required
- **Read:** Read tool returns all lines; each line parsed independently

### Migration
Converted 5 existing entries from `training_log.json` to `training_log.ndjson`. Old file kept for reference.

### Files updated
- `data/training_log.ndjson` — new file (migrated from training_log.json)
- `CLAUDE.md` — Training Log section + Data File Paths updated
- `log-session/SKILL.md` — Step 3 now uses Bash append instead of Read+Write
- `checkin/SKILL.md` — file reference updated
- `weekly-plan/SKILL.md` — file reference updated
- `references/skill_schemas.md` — entry schemas updated to show single-line NDJSON format

### Why this matters
- Log writes are O(1) instead of O(n) — no performance degradation as the log grows
- No risk of data corruption from failed read+rewrite cycles
- Simpler write path: one Bash command instead of Read → parse → modify → Write

---

## Iteration 10 — Direct MCP server launch

**Goal:** Remove unnecessary shell overhead when launching MCP servers.

### Problem
`.mcp.json` launched Python via `cmd /c`:
```json
"command": "cmd",
"args": ["/c", ".venv\\Scripts\\python.exe", "mcp_servers\\weather_mcp.py"]
```
This spawns an extra `cmd.exe` process per server — adds ~50ms startup latency and an unnecessary parent process.

### Change
Launch Python directly:
```json
"command": ".venv\\Scripts\\python.exe",
"args": ["mcp_servers\\weather_mcp.py"]
```

### Files updated
- `.mcp.json` — both `weather` and `strava` server entries updated

### Why this matters
- One fewer process per MCP server (no `cmd.exe` wrapper)
- Faster server startup
- Cleaner process tree — signals go directly to Python

---

## Iteration 11 — Excel parser optimization

**Goal:** Reduce memory usage and speed up `parse_excel.py` by using openpyxl's read-only mode and value-only iteration.

### Changes
1. `load_workbook(args.excel_file, data_only=True)` → `load_workbook(args.excel_file, read_only=True, data_only=True)`
2. `iter_rows(min_row=2, max_row=ws.max_row, max_col=5, values_only=False)` → `iter_rows(min_row=2, max_col=5, values_only=True)`
3. Cell access: `row[0].value` → `row[0]` (values_only returns raw values, not Cell objects)
4. Added `wb.close()` — required in read_only mode to release file handle
5. Removed `max_row=ws.max_row` — not reliably available in read_only mode

### Why this matters
- `read_only=True` uses a streaming XML parser instead of loading the entire workbook into memory
- `values_only=True` skips Cell object creation — returns raw values directly
- Faster parse time and lower memory footprint (matters for larger programs)
- No functional change — output is identical

### Files updated
- `scripts/parse_excel.py` — 3 edits (load_workbook, iter_rows, cell access) + wb.close()

---

## Iteration 12 — Cache artifact cleanup + encoding audit

**Goal:** Remove tracked `.pyc` cache file and verify no text encoding artifacts (mojibake) in prompts/docs.

### Changes

**1. Removed `mcp_servers/__pycache__/weather_mcp.cpython-314.pyc`**
- Only `.pyc` file outside `.venv/` — adds noise to file scans and tool/agent searches
- `.gitignore` already has `__pycache__/` and `*.pyc` rules, so it won't recur

**2. Encoding artifact audit — all clean**
- Searched all `.md` and `.json` files for common mojibake patterns: `Â°`, `â€"`, `â€™`, `\u00c2`, `\u00e2`, `\u0080`
- No encoding artifacts found — all files use clean UTF-8 throughout
- Degree symbols (`°C`), em-dashes, and apostrophes are all properly encoded

### Files updated
- `mcp_servers/__pycache__/` — deleted (contained `weather_mcp.cpython-314.pyc`)

### Why this matters
- `.pyc` files in the project tree slow down glob/grep scans used by Claude Code tools and agents
- Encoding artifacts (`Â°C` instead of `°C`) can confuse model tokenization and produce garbled output
- Confirming clean encoding gives confidence that prompt content is parsed correctly

## Next steps
- Test `/checkin` end-to-end in a live session
- Test `/log-session` to verify NDJSON append works
- Test `/weekly-plan` with real weather + Strava data
- Run benchmark scenarios (7 test cases)
- Write tutorial PDF + record demo video
- Implement multi-program support (future iteration)